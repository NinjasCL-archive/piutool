<html>
<head>
    <link href="https://code.jquery.com/ui/1.12.1/themes/blitzer/jquery-ui.css" rel=stylesheet>
    <style>
        .label      {display: inline-block; width: 100px;}
        .inputField {display: inline-block; width: 220px;}
    </style>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.0/jquery-ui.min.js"></script>
    <script>
        var songList;
        var jsonFile = $.getJSON( "data/songlist_prime2.json", function() {
            songList = jsonFile.responseJSON.songlist;
        });
        var levelRange = [1,28];

        $(function() {
            $("#level").slider({
                range:true,
                min: 1,
                max: 28,
                values: [1, 28],
                slide: function(event, ui) {
                    levelRange = ui.values;
                    $("#levelText").text(ui.values[0] + " - " + ui.values[1]);
                }
            });

            $("#submit").click(function() {
                performSearch();
            });

            document.onkeypress = function (e) {
                if (e.keyCode == 13) {
                    performSearch();
                }
            }

            $("input[name='chartType']").click(function() {
                if (this.value == "coop") {
                    $('input[name="chartType"]').not(this).prop('checked', false);
                    $("#levelSelectorArea").hide();
                }
                else {
                    $('#coopCheckbox').prop('checked', false);
                    $("#levelSelectorArea").show();
                }
            });
        });

        function performSearch() {
            var $checked = $("[name='chartType']").filter(":checked");
                var selectedChartTypes = $checked.map(function() {
                    return this.value;
                }).get();

                console.log("Searching with" +
                    "\nsongName = " + $("#songName").val() + 
                    "\nchartType = " +  selectedChartTypes + 
                    "\nlevel = " + $("#levelText").text());

                var result = searchSongName(songList, $("#songName").val());
                result = searchChart(result, selectedChartTypes, levelRange);
                
                $("#result").html(JSON.stringify(result));
        }

        function searchSongName(arr, part) {
            part = part.toLowerCase();
            return arr.filter(a=>a.songName.toLowerCase().indexOf(part) !== -1);
        }
        
        function searchChart(arr, types, level) {
            if (arr.length == 0) {
                return [];
            }

            var results = [];
            if (types[0] == "coop") {
                arr.forEach(function(song) {
                    var matchedChartList = [];
                    var temp = song.chartList.filter(a=>a.chartType=="coop");
                    if (temp.length > 0){
                        matchedChartList.push(temp);
                    }

                    if (matchedChartList.length > 0) {
                        var resultSong = Object.assign({},song);
                        resultSong.chartList = matchedChartList;
                        results.push(resultSong);
                    }
                });
            }
            else {
                //search stepchart for each type
                arr.forEach(function(song) {
                    var matchedChartList = [];
                    types.forEach(function(type){
                        var temp = song.chartList.filter(a=>
                                                    a.chartType==type && 
                                                    a.level >= level[0] && 
                                                    a.level <= level[1]);
                        if (temp.length > 0) {
                            matchedChartList.push(temp);
                        }
                    });
                    
                    if (matchedChartList.length > 0) {
                        var resultSong = Object.assign({},song);
                        resultSong.chartList = matchedChartList;
                        results.push(resultSong);
                    }
                });
            }
            return results;
        }
    </script>
</head>
<body>
    <h1>Song search tool</h1>
    <p>
        <span class="label">Song Name</span>
        <span class="inputField">
            <input id="songName">
        </span>
    </p>
	<p>
        <span class="label">Chart Type</span>
        <span class="inputField">
            <input type="checkbox" name="chartType" value="single">Single
            <input type="checkbox" name="chartType" value="double">Double
        <br/>
            <input type="checkbox" name="chartType" value="singlePerformance">Single Performance
        <br/>
            <input type="checkbox" name="chartType" value="doublePerformance">Double Performance
        <br/>
            <input type="checkbox" name="chartType" value="coop" id="coopCheckbox">Coop
        </span>
    </p>
    <p>
        <span class="label">
            Version<br/>
            (To be implemented)
        </span>
        <span class="inputField">
            <input type="checkbox" name="version" value="All" checked disabled>All
        <br/>
            <input type="checkbox" name="version" value="1st" checked disabled>1st
            <input type="checkbox" name="version" value="2nd" checked disabled>2nd
            <input type="checkbox" name="version" value="3rd" checked disabled>3rd
            <input type="checkbox" name="version" value="3rdSE" checked disabled>3rdSE
        <br/>
            <input type="checkbox" name="version" value="PerfectCollection" checked disabled>PerfectCollection
            <input type="checkbox" name="version" value="Extra" checked disabled>Extra
        <br/>
            <input type="checkbox" name="version" value="Rebirth" checked disabled>Rebirth
            <input type="checkbox" name="version" value="Premiere3" checked disabled>Premiere3
            <input type="checkbox" name="version" value="Prex3" checked disabled>Prex3
            <input type="checkbox" name="version" value="Exceed" checked disabled>Exceed
            <input type="checkbox" name="version" value="Exceed2" checked disabled>Exceed2
            <input type="checkbox" name="version" value="Zero" checked disabled>Zero
            <input type="checkbox" name="version" value="NX" checked disabled>NX
            <input type="checkbox" name="version" value="NX2" checked disabled>NX2
            <input type="checkbox" name="version" value="NXA" checked disabled>NXA
            <input type="checkbox" name="version" value="Fiesta" checked disabled>Fiesta
            <input type="checkbox" name="version" value="FiestaEX" checked disabled>FiestaEX
            <input type="checkbox" name="version" value="Fiesta2" checked disabled>Fiesta2
            <input type="checkbox" name="version" value="Prime" checked disabled>Prime
            <input type="checkbox" name="version" value="Prime2" checked disabled>Prime2
        </span>
    </p>
    <p id="levelSelectorArea">
        <span class="label">Level</span>
        <span class="inputField" id="levelText">1 - 28</span>
    <br/>
        <span class="label"></span>
        <span class="inputField" id="level"></span>
    </p>
    <p>
        <span class="label"></span>
        <span class="inputField">
            <input type="button" id="submit" value="Go!">
        </span>
    </p>
    <div id="result"></div>
</body>
</html>